---
title: "af_weather"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/slewa/Projects/heat_stress")

library(tidyverse)
library(lubridate)
library(viridis)
library(knitr)
library(kableExtra)
library(zoo)
library(PairedData)
library(broom)

```

**Air Force SAR weather**

This code includes reads in and combines separate Excel worksheets into a single dataframe.  
The hourly data were produced in July 2019 by 14WS and provide WBGT, HI, RH, temperature (F), dew point (F) and UTCI (F).

*Note: For Fort Irwin, Daegu, Hawaii, Yongsan, Red Cloud files, need to insert row prior to line 25 so that header starts on line 26.*



```{r read_function, message = FALSE, warning = FALSE, eval = FALSE}

# sar_file <- "D:/sar_weather/SAR_9860_Aberdeen Proving Ground.csv"  
#
sar_file_list <- list.files(path = "D:/sar_weather", pattern = "^.*\\.(csv)$") %>% 
                    paste0("D:/sar_weather/", .)

sar_file_list %>% head()


read_sar <- function(input_file) {

read_csv((input_file), col_names = TRUE, skip = 25, na = c("", "NA")) %>%
  janitor::clean_names() %>% 
  mutate(location = stringr::str_split((input_file), "9860_") %>% .[[1]] %>% .[2] %>% 
                             str_split(., ".csv") %>% .[[1]] %>% .[1],
             time = paste0(hour, ":", "00", ":", "00"), 
             date = paste(year, month, day, sep = "-"),
             dttm =  paste(date, time, sep = " ") %>% 
                 flipTime::AsDateTime()) %>% 
  dplyr::select(-c(year, month, day, hour, time, date)) %>% 
  dplyr::select(location, dttm, everything()) %>%
  rename(wbgt = wet_bulb_globe_temp,
         rh = relitive_humidity)
}

sar_df <- furrr::future_map_dfr(sar_file_list, read_sar, .progress = TRUE) 

sar_df <- sar_df %>% select(-c(x11, x12, x13))

sar_df

```

## Save file and filter locations

```{r write_csv, eval = FALSE}
# save dataframe to .csv file
# save as .rds

# write_csv(sar_df, "D:/sar_df.csv", append = FALSE)
 
# sar_df <- read_csv("D:/sar_weather/sar_df.csv")

sar_df <- sar_df %>% 
  filter(location %in% c("Fort Benning", "Fort Bragg","Fort Campbell",
      "Fort Jackson", "Fort Polk", "Fort Hood",
      "Fort Stewart", "Fort Leonard Wood", "Fort Riley",
      "Fort Irwin", "Fort Bliss", "Fort Lewis",
      "Fort Sill", "Fort Carson", "Fort Gordon",
      "Fort Drum", "JB San Antonio")
  )

# write_rds(sar_df, path = "data/sar_df.rds")

```

```{r inspect_data}

sar_df <- read_rds("data/sar_df.rds")

sar_df

# Location counts
sar_df %>% 
  count(location) %>%
  head() %>% 
  knitr::kable() %>% 
  kable_styling(bootstrap_options = c("striped", "condensed", full_width = FALSE))
```

## Hour of day mean WBGT
```{r hour_of_day, warning = FALSE, fig.height = 12}

# Plot July hourly WBGT

sar_df %>%   
  filter(months(dttm) == "July") %>% 
  group_by(location, lubridate::year(dttm), lubridate::hour(dttm)) %>% 
  summarise(mean_wbgt = mean(wbgt, na.rm = TRUE)) %>%
  rename(year = `lubridate::year(dttm)`,
         hour = `lubridate::hour(dttm)`) %>% 
  ggplot(aes(x = hour, y = mean_wbgt, color = factor(year))) + 
    geom_point() +
    geom_smooth(aes(group = factor(year)),  size = 0.6, se = FALSE) +
    facet_wrap(~location) +
    labs(
      title = "Mean July WBGT (deg F) by Hour of Day (UTC)",
      x = "Hour of day (UTC)",
      y = "Mean WBGT (deg F)",
      caption = "Data from 14WS/CXO, produced 29 July 2019") +
    theme_bw() +
  viridis::scale_color_viridis(
      name = "Year", 
      discrete = TRUE,
      direction = -1,
      option = "inferno") 



```

## Yearly mean temperature boxplots

```{r yearly_boxplot, fig.height = 10}
# Locations 1 - 12
sar_df %>%   
  dplyr::select(location, dttm, temp_f) %>%
  mutate(location = as_factor(location),
         year = as.factor(lubridate::year(dttm))) %>%
  filter(as.numeric(location) > 2) %>%
  filter(as.numeric(location) <= 11) %>% 
  group_by(location, lubridate::year(dttm)) %>% 
  ggplot(aes(x = year, 
             y = temp_f)) +
    geom_boxplot() +
    facet_wrap(~location, ncol = 3) +
    labs(
      title = "Yearly mean temperatures (deg F)",
      x = "Year",
      y = "Temperature (deg F)",
      caption = "Data from 14WS/CXO, produced 29 July 2019") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, size = 6, hjust = 1))
```


## Compare with NLDAS-2 temperature and heat indices

```{r join_nldas}

nldas_wide <- read_rds("data/nldas_wide.rds") 

nldas_wide

af_nldas_compare <-
  sar_df %>% 
    mutate(location = 
             str_to_lower(location, locale = "en"),
             location = str_replace_all(location, " ", "_"),
             location = recode(location, fort_benning = "fort_benning_ga", fort_irwin = "ntc_and_fort_irwin")) %>% 
    left_join(nldas_wide, by = c("location" = "installation", "dttm" = "utc_dttm")) %>% 
    dplyr::select(location, dttm, wbgt.x, heat_index.x, temp_f, wbgt_f, heat_index.y, tmp_f) %>% 
    rename(installation = location,
           utc_dttm = dttm,
           wbgt_af = wbgt.x,
           heat_index_af = heat_index.x,
           temp_af = temp_f,
           wbgt_nldas = wbgt_f,
           heat_index_nldas = heat_index.y,
           tmp_nldas = tmp_f)


af_nldas_compare 


```

##  Plots
```{r plots, fig.height = 20}


af_nldas_compare %>%
    dplyr::select(installation, utc_dttm, temp_af, tmp_nldas) %>% 
    na.omit() %>% 
  ggplot(aes(x = temp_af, y = tmp_nldas)) + 
      geom_point(alpha = 0.2) +
      geom_smooth(method = lm, se = FALSE) +
      facet_wrap(~installation, ncol = 3) +
      labs(
        title = "Temperature Comparison",
        x = "Air Force Station",
        y = "NLDAS") +
      theme_bw()




af_nldas_compare %>%
    dplyr::select(installation, utc_dttm, wbgt_af, wbgt_nldas) %>% 
    na.omit() %>% 
  ggplot(aes(x = wbgt_af, y = wbgt_nldas)) + 
      geom_point(alpha = 0.2) +
      geom_smooth(method = lm, se = FALSE) +
      facet_wrap(~installation, ncol = 3) +
      labs(
        title = "WBGT Comparison",
        x = "Air Force Station",
        y = "NLDAS") +
      theme_bw()


```

## Statistical comparison: t-tests
```{r t_tests}
# https://cran.r-project.org/web/packages/BlandAltmanLeh/vignettes/Intro.html

# WBGT

af_nldas_compare %>%
    dplyr::select(installation, utc_dttm, wbgt_af, wbgt_nldas) %>% 
    na.omit() %>% 
  group_by(installation) %>% 
  do(tidy(t.test(.$wbgt_af, 
                 .$wbgt_nldas, 
                 mu = 0, 
                 alt = "two.sided", 
                 paired = TRUE, 
                 conf.level = 0.99))) %>% 
  knitr::kable() %>% 
  kable_styling(bootstrap_options = c("striped", "condensed", full_width = FALSE))
  

# Temperature

af_nldas_compare %>%
    dplyr::select(installation, utc_dttm, temp_af, tmp_nldas) %>% 
    na.omit() %>% 
  group_by(installation) %>% 
  do(tidy(t.test(.$temp_af, 
                 .$tmp_nldas, 
                 mu = 0, 
                 alt = "two.sided", 
                 paired = TRUE, 
                 conf.level = 0.99))) %>% 
  knitr::kable() %>% 
  kable_styling(bootstrap_options = c("striped", "condensed", full_width = FALSE))
```


---
title: "mixed_models_poisson"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/slewa/Projects/heat_stress")

library(tidyverse)
library(readxl)
library(lubridate)
library(viridis)
library(knitr)
library(kableExtra)
library(zoo)
library(purrr)
library(furrr)
library(table1)
library(furniture)
library(kableExtra)
library(visdat)
library(naniar)
library(modelr)
library(lme4)
library(ICC) 
library(dotwhisker)
library(broom)
library(car)
library(reshape2)
library(sjPlot)
library(ggridges)


```

Annual models from DMED data.


Scope:

  CONUS Army Installations:  
  
    Fort Jackson, SC     
    Fort Benning, GA    
    Fort Bragg, NC  
    Fort Campbell, KY  
    Fort Polk, LA  
    Fort Hood, TX  
    Fort Stewart, GA  
    Fort Leonard Wood, MO
    Fort Riley, KS  
    Fort Irwin, CA  
    Fort Bliss, TX  
      
Population: Active-duty Army service members  

**Outcome**:
  Ambulatory (Out-patient)  
  Annual Rate of Heat Stress Illness (any type, primary diagnosis)  
  1997 - 2018
  
**Exposure indices**:  
*“Absolute” indices*  
  Annual mean (full-year): temperature, heat index, WBGT  
  Annual heat risk days / hours - Heat index above 80 / 90 / 103 / 125 °F - WBGT above 82 / 85 / 88 / 90 °F  
  
*“Relative” indices* (averaged over full-year and heat season months) 
Annual mean daily anomaly: temperature, heat index, WBGT  
Annual maximum daily anomaly: temperature, heat index, WBGT  
Days mean temperature index above daily climate normal percentile (averaged over all hours of day)  
  - temperature, heat index, WBGT above 85th / 90th / 95th percentiles  
Days maximum temperature index above daily climate normal maximum percentile  
  - temperature, heat index, WBGT above 85th / 90th / 95th percentiles  
Days mean temperature index above Standard Deviation(s) of mean daily temperature climate normal  
  - temperature, heat index, WBGT above 1 or 2 standard deviations of daily normal  
Days maximum temperature index above Standard Deviation(s) of max daily temperature climate normal  
  - temperature, heat index, WBGT above 1 or 2 standard deviations of maximum daily normal  

```{r read_data}

# Outcomes
dmed_tidy <- 
  read_rds("data/dmed_tidy.rds")

dmed_tidy

# Exposures
annual_tables_list <-
  read_rds("data/annual_tables_list.rds")

annual_tables_list

```


```{r joined_rate_population}

dmed_population <-
  dmed_tidy %>% 
  filter(!location %in% c("us", "overseas"),
         type == "Ambulatory Data",
         hsi == "all",
         strata == "gender",
         category == "Total") %>% 
  dplyr::select(location, year, population) %>% 
    mutate(location = dplyr::recode(location, jackson = "fort_jackson"),
           location = dplyr::recode(location, benning = "fort_benning_ga"),                 
           location = dplyr::recode(location, bragg = "fort_bragg"),
           location = dplyr::recode(location, campbell = "fort_campbell"),
           location = dplyr::recode(location, polk = "fort_polk"),
           location = dplyr::recode(location, hood = "fort_hood"),
           location = dplyr::recode(location, stewart = "fort_stewart"),
           location = dplyr::recode(location, leonardwood = "fort_leonard_wood"),
           location = dplyr::recode(location, riley = "fort_riley"),
           location = dplyr::recode(location, irwin = "ntc_and_fort_irwin"),
           location = dplyr::recode(location, bliss = "fort_bliss"),
           location = as.character(location))


index_long <- 
  annual_tables_list %>% 
    filter(installation %in% c("fort_benning_ga", "fort_bragg", "fort_campbell", "fort_jackson",
                               "fort_polk", "fort_hood", "fort_stewart", "fort_leonard_wood", "fort_riley",
                               "ntc_and_fort_irwin", "fort_bliss")) %>% 
    unnest(data) %>% 
    pivot_longer(., cols = `1990`:`2019`, names_to = "year", values_to = "value") %>% 
    mutate(year = as.integer(year)) 


hsi_rates <-
  dmed_tidy %>% 
    filter(location %in% c("benning", "bragg", "campbell", "jackson",
                           "polk", "hood", "stewart", "leonardwood", 
                           "riley", "irwin", "bliss"),
           type == "Ambulatory Data",
           hsi == "all",
           strata == "gender",
           category == "Total") %>% 
    dplyr::select(location, year, rate) %>% 
    dplyr::mutate(location = dplyr::recode(location, jackson = "fort_jackson"),
           location = dplyr::recode(location, benning = "fort_benning_ga"),                 
           location = dplyr::recode(location, bragg = "fort_bragg"),
           location = dplyr::recode(location, campbell = "fort_campbell"),
           location = dplyr::recode(location, polk = "fort_polk"),
           location = dplyr::recode(location, hood = "fort_hood"),
           location = dplyr::recode(location, stewart = "fort_stewart"),
           location = dplyr::recode(location, leonardwood = "fort_leonard_wood"),
           location = dplyr::recode(location, riley = "fort_riley"),
           location = dplyr::recode(location, irwin = "ntc_and_fort_irwin"),
           location = dplyr::recode(location, bliss = "fort_bliss"),
           location = as.character(location))


hsi_counts <-
  dmed_tidy %>% 
    filter(location %in% c("benning", "bragg", "campbell", "jackson",
                           "polk", "hood", "stewart", "leonardwood", 
                           "riley", "irwin", "bliss"),
           type == "Ambulatory Data",
           hsi == "all",
           strata == "gender",
           category == "Total") %>% 
    dplyr::select(location, year, count, population) %>% 
    dplyr::mutate(location = dplyr::recode(location, jackson = "fort_jackson"),
           location = dplyr::recode(location, benning = "fort_benning_ga"),                 
           location = dplyr::recode(location, bragg = "fort_bragg"),
           location = dplyr::recode(location, campbell = "fort_campbell"),
           location = dplyr::recode(location, polk = "fort_polk"),
           location = dplyr::recode(location, hood = "fort_hood"),
           location = dplyr::recode(location, stewart = "fort_stewart"),
           location = dplyr::recode(location, leonardwood = "fort_leonard_wood"),
           location = dplyr::recode(location, riley = "fort_riley"),
           location = dplyr::recode(location, irwin = "ntc_and_fort_irwin"),
           location = dplyr::recode(location, bliss = "fort_bliss"),
           location = as.character(location))



# Function to assign Basic Combat Training (BCT) category



joined_rate <-
  index_long %>% 
    left_join(hsi_rates, by = c("installation" = "location", "year" = "year")) %>% 
    drop_na(rate)


joined_rate_pop <-
  joined_rate %>%
    left_join(dmed_population, by = c("installation" = "location", "year"))

joined_counts <-
  index_long %>% 
    left_join(hsi_counts, by = c("installation" = "location", "year" = "year")) %>% 
      drop_na(count) %>% 
  mutate(bct = case_when(installation %in% c("fort_benning_ga", "fort_jackson", "fort_leonard_wood") ~ 1,
                         !installation %in% c("fort_benning_ga", "fort_jackson", "fort_leonard_wood") ~ 0))


```


## Plots of HSI Ambulatory Counts

```{r plot_ambulatory_rates, cache = TRUE, warning = FALSE}

joined_counts %>% 
 ggplot(aes(x = year, y = population, color = installation, shape = installation)) +
    geom_line() +
    geom_point() +
    labs(
      title = "Population",
      y = "Population",
      x = "Year"
    ) +
    scale_shape_manual(values = 0:11) +
    theme_bw() 


joined_counts %>% 
 ggplot(aes(x = count)) +
    geom_histogram(color = "darkblue", fill = "lightblue") +
    facet_wrap(installation ~ .) +
    labs(
      title = "Army Heat Stress Illness Ambulatory Counts, 1997-2018",
      y = "Installation",
      x = "HSI count"
    ) +
    theme_bw() 


```

## Examine single index of heat (out of 80+ indices)  

Annual hours WBGT greater than 85 deg F
```{r}


joined_counts %>% 
  filter(index %in% "hours_wbgt_gt85") %>% 
  ggplot(aes(x = year, y = count)) +
    geom_point() +
    geom_smooth(method = lm, se = FALSE, size = 0.8) +
    labs(
      title = "Army Heat Stress Illness Ambulatory Counts",
      x = "Year",
      y = "HSI count"
    ) +
    theme_bw() 


joined_counts %>% 
  filter(index %in% "hours_wbgt_gt85") %>% 
  ggplot(aes(x = year, y = count, color = installation, shape = installation)) +
    geom_point() +
    geom_smooth(method = lm, se = FALSE, size = 0.8) +
    labs(
      title = "Army Heat Stress Illness Ambulatory Counts",
      x = "Year",
      y = "HSI count"
    ) +
    theme_bw() 


joined_counts %>% 
  filter(index %in% "hours_wbgt_gt85") %>% 
  ggplot(aes(x = value, y = count, color = installation, shape = installation)) +
    geom_point() +
    geom_smooth(method = lm, se = FALSE, size = 0.8) +
    labs(
      title = "Army Heat Stress Illness Ambulatory Counts at 11 Installations (1997-2018)",
      x = "Hours WBGT > 85 deg F",
      y = "HSI count"
    ) +
    scale_shape_manual(values = 0:11) +
    theme_bw() 



joined_counts %>% 
   filter(index %in% "hours_wbgt_gt85") %>% 
 ggplot(aes(x = value, y = fct_reorder(installation, value))) +
    ggridges::geom_density_ridges(
       jittered_points = TRUE,
       aes(point_color = installation, point_fill = installation), 
       alpha = 0.5,
       point_alpha = 1) +
    labs(
      title = "Hours WBGT exceeding 85 deg F, 1997-2018",
      y = "Installation",
      x = "Hours WBGT > 85"
    ) +
    theme_bw() +
    theme(legend.position = "none")
```


1. Ambulatory HSI rates increased over time.
2. WBGT temperatures increased over time.
3. Slopes of HSI rate change vary by installation.
4. Slopes of WBGT increase are consistent by installation (clusters below 100 hours/year and above 200 hours/year).
5. HSI rates increase with the number of hours of WBGT exceeding 85 deg F.
6. Slopes of HSI rate increases with hours WBGT > 85 vary by installation (among installations with the highest HSI rates). 

## Models

```{r scaled}

# Assign dataset; center and scale predictor value

data_hours_wbgt_gt85_counts <-
  joined_counts %>% 
    filter(index %in% "hours_wbgt_gt85") %>% 
    mutate(value_scaled = scale(value, center = TRUE, scale = TRUE))


```

```{r models}
# Fitting ‘installation’ as a fixed effect in model M1 assumes 
# the 11 ‘installation’ means are all independent of one another, 
# and share a common residual variance

pooled <- glm(count ~ value + installation, data = data_hours_wbgt_gt85_counts)
summary(pooled)

pooled_offset <- glm(count ~ value + installation, data = data_hours_wbgt_gt85_counts, offset = log(population))
summary(pooled_offset)


# Fitting installation as a random intercept model in model M2 assumes that the 1 measured
# installation means are only a subset of the realised possibilities drawn from a ‘global’ set of
# population means that follow a Normal distribution with its own mean and variance.

random_intercept <- glmer(count ~ value_scaled + (1|installation), data = data_hours_wbgt_gt85_counts, family = poisson, offset = log(population))

# Fitting random intercepts and slopes allows the slope of a 
# predictor to vary based on a separate grouping variable.



poisson_mod <- glm(count ~ value_scaled + installation, data = data_hours_wbgt_gt85_counts, family = poisson)
sjPlot::tab_model(poisson_mod, p.val = "kr", show.df = TRUE)

poisson_mod_offset <- glm(count ~ value_scaled + installation, data = data_hours_wbgt_gt85_counts, family = poisson, offset = log(population))
sjPlot::tab_model(poisson_mod, poisson_mod_offset, p.val = "kr", show.df = TRUE)



random_intercept_slope <- glmer(count ~ value_scaled + (1 + value_scaled|installation), data = data_hours_wbgt_gt85_counts, family = poisson, offset = log(population))

random_intercept_slope_bct <- glmer(count ~ value_scaled + bct + (1 + value_scaled|installation), data = data_hours_wbgt_gt85_counts, family = poisson, offset = log(population))



summary(random_intercept_slope)
sjPlot::tab_model(random_intercept_slope, p.val = "kr", show.df = TRUE)


random_intercept_slope_no_offset <- glmer(count ~ value_scaled + (1 + value_scaled|installation), data = data_hours_wbgt_gt85_counts, family = poisson)



summary(random_intercept_slope_no_offset)
sjPlot::tab_model(random_intercept_slope_no_offset, p.val = "kr", show.df = TRUE)

```




## Model Evaluation

```{r}

sjPlot::tab_model(random_intercept_slope, random_intercept_slope_bct, p.val = "kr", show.df = TRUE)

sjPlot::tab_model(random_intercept_slope_no_offset, p.val = "kr", show.df = TRUE)

broom::glance(random_intercept_slope)
broom::glance(random_intercept_slope_bct)
broom::tidy(random_intercept_slope)
broom::tidy(random_intercept_slope_bct)

```

## Plot models

```{r}
# Mod 1
plot(random_intercept_slope)

sjPlot::plot_model(random_intercept_slope)

sjPlot::plot_model(random_intercept_slope, type = "pred", terms = "value_scaled")
sjPlot::plot_model(random_intercept_slope, type = "re", terms = "value_scaled")
sjPlot::plot_model(random_intercept_slope, type = "resid", terms = "value_scaled")
sjPlot::plot_model(random_intercept_slope, type = "diag", terms = "value_scaled")


sjPlot::plot_model(random_intercept_slope_no_offset)
sjPlot::plot_model(random_intercept_slope_no_offset, type = "pred", terms = "value_scaled")
sjPlot::plot_model(random_intercept_slope_no_offset, type = "re", terms = "value_scaled")

sjPlot::plot_model(poisson_mod)
sjPlot::plot_model(poisson_mod_offset)



sjPlot::plot_model(random_intercept_slope_bct)
sjPlot::plot_model(random_intercept_slope_bct, type = "pred", terms = "value_scaled")
sjPlot::plot_model(random_intercept_slope_bct, type = "re", terms = "value_scaled")
```


## Multiple Models Function


```{r glmer_function}

# center and scale by each index (pooled over all installations)  

joined_counts_scaled <-
  joined_counts %>% 
    ungroup() %>% 
    dplyr::group_by(index) %>% 
      mutate(value_scaled = scale(value, center = TRUE, scale = TRUE)) %>% 
    ungroup()



gg_miss_var(joined_counts_scaled)
gg_miss_var(joined_counts_scaled,
            facet = index)

# missing values for indices gt 125 deg
# omit observations with missing records

joined_counts_scaled <-
  joined_counts_scaled %>% 
  na.omit()

joined_counts_scaled
# write_rds(joined_counts_scaled, "data/joined_counts_scaled.rds")


random_slope_bct_function = function(df) {
  df %>% 
    glmer(count ~ value_scaled + bct + (1 + value_scaled|installation), data = ., family = poisson, offset = log(population))
}


random_slope_bct_nest <-
  joined_counts_scaled %>%
    dplyr::select(index, everything()) %>% 
      nest(data = installation:value_scaled) %>% 
      mutate(glmer_models = map(data, random_slope_bct_function),
             glance = map(glmer_models, broom::glance),
             tidy =   map(glmer_models, broom::tidy),
             augment = map(glmer_models, broom::augment))


random_slope_bct_nest 

# Check singular fit models

map(random_slope_bct_nest$glmer_models, isSingular) %>% 
  unlist() %>% 
  tibble::enframe(name = NULL) %>% 
  mutate(index = random_slope_bct_nest$index) %>% 
  filter(value %in% "TRUE")

# Remove `days_wbgt_gt95pct_may_sep`: singular fit model

random_slope_bct_nest <-
  random_slope_bct_nest %>% 
  filter(!index %in% "days_wbgt_gt95pct_may_sep")


# write_rds(random_slope_bct_nest, "data/random_slope_bct_nest.rds")



# Model summaries

random_slope_bct_nest  %>% 
  unnest(tidy, .drop = TRUE) %>% 
  dplyr::select(index, term:group) %>%
  filter(term %in% "value_scaled") %>% 
  arrange(desc(estimate))


random_slope_bct_nest  %>% 
  unnest(tidy, .drop = TRUE) %>% 
  dplyr::select(index, term:group) %>%
  filter(term %in% "bct") %>% 
  arrange(desc(estimate))



random_slope_bct_nest  %>% 
  unnest(glance, .drop = TRUE) %>% 
  dplyr::select(index, sigma:df.residual) %>% 
  arrange(AIC)



```

```{r}
random_slope_bct_nest %>% 
  pull(glmer_models) %>% 
  map(sjPlot::plot_model)
```


